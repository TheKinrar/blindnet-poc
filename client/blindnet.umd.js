!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).blindnet=t()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};function t(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return(n=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function r(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var o,s={},a=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e,t){
/*! noble-ed25519 - MIT License (c) Paul Miller (paulmillr.com) */
Object.defineProperty(t,"__esModule",{value:!0}),t.utils=t.verify=t.sign=t.getPublicKey=t.SignResult=t.Signature=t.Point=t.ExtendedPoint=t.CURVE=void 0;const n={a:-1n,d:37095705934669439343138083508754565189542113879843219016388785533085940283555n,P:2n**255n-19n,n:2n**252n+27742317777372353535851937790883648493n,h:8n,Gx:15112221349535400772501151409588531511454012693041857206046113283949847762202n,Gy:46316835694926478169428394003475163141307993866256225615783033603165251855960n};t.CURVE=n;const r=32,i=19681161376707505956807079304988542015446066515923890162744021073123829784752n,o=25063068953384623474111414158702152701244531502492656460079210482610430750235n,a=54469307008909316920995813868745141605393597292927456921205312896311721017578n,c=1159843021668779879193775521855586647937357759715417654439879720876111806838n,u=40440834346308536858101042469323190826248399146238708352240133220865137265952n;class f{constructor(e,t,n,r){this.x=e,this.y=t,this.z=n,this.t=r}static fromAffine(e){if(!(e instanceof l))throw new TypeError("ExtendedPoint#fromAffine: expected Point");return e.equals(l.ZERO)?f.ZERO:new f(e.x,e.y,1n,E(e.x*e.y))}static toAffineBatch(e){const t=function(e,t=n.P){const r=e.length,i=new Array(r);let o=1n;for(let n=0;n<r;n++)0n!==e[n]&&(i[n]=o,o=E(o*e[n],t));o=S(o,t);for(let n=r-1;n>=0;n--){if(0n===e[n])continue;let r=E(o*e[n],t);e[n]=E(o*i[n],t),o=r}return e}(e.map((e=>e.z)));return e.map(((e,n)=>e.toAffine(t[n])))}static normalizeZ(e){return this.toAffineBatch(e).map(this.fromAffine)}static fromRistrettoHash(e){const t=A(e.slice(0,r)),n=this.calcElligatorRistrettoMap(t),i=A(e.slice(r,64)),o=this.calcElligatorRistrettoMap(i);return n.add(o)}static calcElligatorRistrettoMap(e){const{d:t}=n,r=E(i*e*e),s=E((r+1n)*c);let a=-1n;const y=E((a-t*r)*E(r+t));let{isValid:l,value:d}=P(s,y),p=E(d*e);b(p)||(p=E(-p)),l||(d=p),l||(a=r);const h=E(a*(r-1n)*u-y),w=d*d,v=E((d+d)*y),g=E(h*o),m=E(1n-w),A=E(1n+w);return new f(E(v*A),E(m*g),E(g*A),E(v*m))}static fromRistrettoBytes(e){const{a:t,d:i}=n,o="ExtendedPoint.fromRistrettoBytes: Cannot convert bytes to Ristretto Point",s=A(e);if(!function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0}(v(s,r),e)||b(s))throw new Error(o);const a=E(s*s),c=E(1n+t*a),u=E(1n-t*a),y=E(c*c),l=E(u*u),d=E(t*i*y-l),{isValid:p,value:h}=U(E(d*l)),w=E(h*u),g=E(h*w*d);let m=E((s+s)*w);b(m)&&(m=E(-m));const S=E(c*g),K=E(m*S);if(!p||b(K)||0n===S)throw new Error(o);return new f(m,S,1n,K)}toRistrettoBytes(){let{x:e,y:t,z:n,t:o}=this;const s=E((n+t)*(n-t)),c=E(e*t),{value:u}=U(E(s*c**2n)),f=E(u*s),y=E(u*c),l=E(f*y*o);let d;b(o*l)?([e,t]=[E(t*i),E(e*i)],d=E(f*a)):d=y,b(e*l)&&(t=E(-t));let p=E((n-t)*d);return b(p)&&(p=E(-p)),v(p,r)}equals(e){const t=e,[n,r,i,o]=[this.t,t.t,this.z,t.z];return E(n*o)===E(r*i)}negate(){return new f(E(-this.x),this.y,this.z,E(-this.t))}double(){const e=this.x,t=this.y,r=this.z,{a:i}=n,o=E(e**2n),s=E(t**2n),a=E(2n*r**2n),c=E(i*o),u=E((e+t)**2n-o-s),y=E(c+s),l=E(y-a),d=E(c-s),p=E(u*l),h=E(y*d),w=E(u*d),v=E(l*y);return new f(p,h,v,w)}add(e){const t=this.x,n=this.y,r=this.z,i=this.t,o=e.x,s=e.y,a=e.z,c=e.t,u=E((n-t)*(s+o)),y=E((n+t)*(s-o)),l=E(y-u);if(0n===l)return this.double();const d=E(2n*r*c),p=E(2n*i*a),h=E(p+d),w=E(y+u),v=E(p-d),b=E(h*l),g=E(w*v),m=E(h*v),A=E(l*w);return new f(b,g,A,m)}subtract(e){return this.add(e.negate())}multiplyUnsafe(e){if(!g(e))throw new TypeError("Point#multiply: expected number or bigint");let t=E(BigInt(e),n.n);if(1n===t)return this;let r=f.ZERO,i=this;for(;t>0n;)1n&t&&(r=r.add(i)),i=i.double(),t>>=1n;return r}precomputeWindow(e){const t=256/e+1;let n=[],r=this,i=r;for(let o=0;o<t;o++){i=r,n.push(i);for(let t=1;t<2**(e-1);t++)i=i.add(r),n.push(i);r=i.double()}return n}wNAF(e,t){!t&&this.equals(f.BASE)&&(t=l.BASE);const n=t&&t._WINDOW_SIZE||1;if(256%n)throw new Error("Point#wNAF: Invalid precomputation window, must be power of 2");let r=t&&y.get(t);r||(r=this.precomputeWindow(n),t&&1!==n&&(r=f.normalizeZ(r),y.set(t,r)));let i=f.ZERO,o=f.ZERO;const s=256/n+1,a=2**(n-1),c=BigInt(2**n-1),u=2**n,d=BigInt(n);for(let t=0;t<s;t++){const n=t*a;let s=Number(e&c);if(e>>=d,s>a&&(s-=u,e+=1n),0===s)o=o.add(t%2?r[n].negate():r[n]);else{const e=r[n+Math.abs(s)-1];i=i.add(s<0?e.negate():e)}}return[i,o]}multiply(e,t){if(!g(e))throw new TypeError("Point#multiply: expected number or bigint");const r=E(BigInt(e),n.n);return f.normalizeZ(this.wNAF(r,t))[0]}toAffine(e=S(this.z)){const t=E(this.x*e),n=E(this.y*e);return new l(t,n)}}t.ExtendedPoint=f,f.BASE=new f(n.Gx,n.Gy,1n,E(n.Gx*n.Gy)),f.ZERO=new f(0n,1n,1n,0n);const y=new WeakMap;class l{constructor(e,t){this.x=e,this.y=t}_setWindowSize(e){this._WINDOW_SIZE=e,y.delete(this)}static fromHex(e){const{d:t,P:r}=n,i=e instanceof Uint8Array?e:h(e);if(32!==i.length)throw new Error("Point.fromHex: expected 32 bytes");const o=i[31],s=-129&o,a=0!=(128&o),c=m(Uint8Array.from(Array.from(i.slice(0,31)).concat(s)));if(c>=r)throw new Error("Point.fromHex expects hex <= Fp");const u=E(c*c),f=E(u-1n),y=E(t*u+1n);let{isValid:d,value:p}=P(f,y);if(!d)throw new Error("Point.fromHex: invalid y coordinate");return a!==(1n===(1n&p))&&(p=E(-p)),new l(p,c)}static async fromPrivateKey(e){const n=await t.utils.sha512(O(e));return l.BASE.multiply(x(n))}toRawBytes(){const e=w(this.y),t=new Uint8Array(r);for(let n=e.length-2,i=0;i<r&&n>=0;n-=2,i++)t[i]=Number.parseInt(e[n]+e[n+1],16);const n=1n&this.x?128:0;return t[31]|=n,t}toHex(){return p(this.toRawBytes())}toX25519(){return E((1n+this.y)*S(1n-this.y))}equals(e){return this.x===e.x&&this.y===e.y}negate(){return new l(E(-this.x),this.y)}add(e){return f.fromAffine(this).add(f.fromAffine(e)).toAffine()}subtract(e){return this.add(e.negate())}multiply(e){return f.fromAffine(this).multiply(e,this).toAffine()}}t.Point=l,l.BASE=new l(n.Gx,n.Gy),l.ZERO=new l(0n,1n);class d{constructor(e,t){this.r=e,this.s=t}static fromHex(e){e=B(e);const t=l.fromHex(e.slice(0,32)),r=m(e.slice(32));if(!(0<(i=r)&&i<n.n))throw new Error("Signature.fromHex expects s <= CURVE.n");var i;return new d(t,r)}toRawBytes(){const e=h(w(this.s)).reverse(),t=new Uint8Array(r);t.set(e);const n=new Uint8Array(64);return n.set(this.r.toRawBytes()),n.set(t,32),n}toHex(){return p(this.toRawBytes())}}function p(e){let t="";for(let n=0;n<e.length;n++)t+=e[n].toString(16).padStart(2,"0");return t}function h(e){if("string"!=typeof e)throw new TypeError("hexToBytes: expected string, got "+typeof e);if(e.length%2)throw new Error("hexToBytes: received invalid unpadded hex");const t=new Uint8Array(e.length/2);for(let n=0;n<t.length;n++){const r=2*n;t[n]=Number.parseInt(e.slice(r,r+2),16)}return t}function w(e){const t=e.toString(16);return 1&t.length?`0${t}`:t}function v(e,t=32){return h(w(e).padStart(2*t,"0")).reverse()}function b(e){return 1n===(1n&E(e))}function g(e){return"bigint"==typeof e&&e>0n||!!("number"==typeof e&&e>0&&Number.isSafeInteger(e))}function m(e){let t=0n;for(let n=0;n<e.length;n++)t+=BigInt(e[n])<<8n*BigInt(n);return t}function A(e){return E(m(e)&2n**255n-1n)}function E(e,t=n.P){const r=e%t;return r>=0n?r:t+r}function S(e,t=n.P){if(0n===e||t<=0n)throw new Error(`invert: expected positive integers, got n=${e} mod=${t}`);let r=E(e,t),i=t,[o,s,a,c]=[0n,1n,1n,0n];for(;0n!==r;){const e=i/r,t=i%r,n=o-a*e,u=s-c*e;[i,r]=[r,t],[o,s]=[a,c],[a,c]=[n,u]}if(1n!==i)throw new Error("invert: does not exist");return E(o,t)}function K(e,t){const{P:r}=n;let i=e;for(;t-- >0n;)i*=i,i%=r;return i}function P(e,t){const r=E(t*t*t),o=E(r*r*t);let s=E(e*r*function(e){const{P:t}=n,r=e*e%t*e%t,i=K(r,2n)*r%t,o=K(i,1n)*e%t,s=K(o,5n)*o%t,a=K(s,10n)*s%t,c=K(a,20n)*a%t,u=K(c,40n)*c%t,f=K(u,80n)*u%t,y=K(f,80n)*u%t,l=K(y,10n)*s%t;return K(l,2n)*e%t}(e*o));const a=E(t*s*s),c=s,u=E(s*i),f=a===e,y=a===E(-e),l=a===E(-e*i);return f&&(s=c),(y||l)&&(s=u),b(s)&&(s=E(-s)),{isValid:f||y,value:s}}function U(e){return P(1n,e)}async function k(...e){const r=function(...e){if(1===e.length)return e[0];const t=e.reduce(((e,t)=>e+t.length),0),n=new Uint8Array(t);for(let t=0,r=0;t<e.length;t++){const i=e[t];n.set(i,r),r+=i.length}return n}(...e);return E(m(await t.utils.sha512(r)),n.n)}function x(e){const t=e.slice(0,r);return t[0]&=248,t[31]&=127,t[31]|=64,E(m(t),n.n)}function B(e){return e instanceof Uint8Array?e:h(e)}function O(e){let t;if("bigint"==typeof e||"number"==typeof e&&Number.isSafeInteger(e)){if(t=BigInt(e),t<0n||t>2n**256n)throw new Error("Expected 32 bytes of private key");e=t.toString(16).padStart(64,"0")}if("string"==typeof e){if(64!==e.length)throw new Error("Expected 32 bytes of private key");return h(e)}if(e instanceof Uint8Array){if(32!==e.length)throw new Error("Expected 32 bytes of private key");return e}throw new TypeError("Expected valid private key")}t.Signature=d,t.SignResult=d,t.getPublicKey=async function(e){const t=await l.fromPrivateKey(e);return"string"==typeof e?t.toHex():t.toRawBytes()},t.sign=async function(e,i){const o=await t.utils.sha512(O(i)),s=x(o),a=l.BASE.multiply(s),c=B(e),u=await k((f=o,f.slice(r)),c);var f;const y=l.BASE.multiply(u),p=E(u+await k(y.toRawBytes(),a.toRawBytes(),c)*s,n.n),h=new d(y,p);return"string"==typeof e?h.toHex():h.toRawBytes()},t.verify=async function(e,t,n){t=B(t),n instanceof l||(n=l.fromHex(n)),e instanceof d||(e=d.fromHex(e));const r=await k(e.r.toRawBytes(),n.toRawBytes(),t),i=f.fromAffine(n).multiplyUnsafe(r),o=f.BASE.multiply(e.s);return f.fromAffine(e.r).add(i).subtract(o).multiplyUnsafe(8n).equals(f.ZERO)},l.BASE._setWindowSize(8),t.utils={TORSION_SUBGROUP:["0100000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac037a","0000000000000000000000000000000000000000000000000000000000000080","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc05","ecffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7f","26e8958fc2b227b045c3f489f2ef98f0d5dfac05d3c63339b13802886d53fc85","0000000000000000000000000000000000000000000000000000000000000000","c7176a703d4dd84fba3c0b760d10670f2a2053fa2c39ccc64ec7fd7792ac03fa"],randomPrivateKey:(e=32)=>{if("object"==typeof self&&"crypto"in self)return self.crypto.getRandomValues(new Uint8Array(e));if("object"==typeof process&&"node"in process.versions){const{randomBytes:t}=s;return new Uint8Array(t(e).buffer)}throw new Error("The environment doesn't have randomBytes function")},sha512:async e=>{if("object"==typeof self&&"crypto"in self){const t=await self.crypto.subtle.digest("SHA-512",e.buffer);return new Uint8Array(t)}if("object"==typeof process&&"node"in process.versions){const{createHash:t}=s,n=t("sha512");return n.update(e),Uint8Array.from(n.digest())}throw new Error("The environment doesn't have sha512 function")},precompute(e=8,t=l.BASE){const n=t.equals(l.BASE)?t:new l(t.x,t.y);return n._setWindowSize(e),n.multiply(1n),n}}}));(o=a)&&o.__esModule&&Object.prototype.hasOwnProperty.call(o,"default")&&o.default;var c=a.utils;a.verify;var u=a.sign,f=a.getPublicKey;function y(e){return new Promise(((t,n)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>n(e.error)}))}function l(e,t){const n=(!navigator.userAgentData&&/Safari\//.test(navigator.userAgent)&&!/Chrom(e|ium)\//.test(navigator.userAgent)&&indexedDB.databases?new Promise((function(e){var t=function(){return indexedDB.databases().finally(e)};r=setInterval(t,100),t()})).finally((function(){return clearInterval(r)})):Promise.resolve()).then((()=>{const n=indexedDB.open(e);return n.onupgradeneeded=()=>n.result.createObjectStore(t),y(n)}));var r;return(e,r)=>n.then((n=>r(n.transaction(t,e).objectStore(t))))}let d;function p(){return d||(d=l("keyval-store","keyval")),d}function h(e,t=p()){return t("readonly",(t=>y(t.get(e))))}a.SignResult,a.Signature,a.Point,a.ExtendedPoint,a.CURVE;var w=function(){var e=this;this.store=l("blindnetKeys","keys"),this.storeKey=function(t,n){return function(e,t,n=p()){return n("readwrite",(n=>(n.put(t,e),y(n.transaction))))}(t,n,e.store)},this.storeKeys=function(t,n,r,i,o){return function(e,t=p()){return t("readwrite",(t=>(e.forEach((e=>t.put(e[1],e[0]))),y(t.transaction))))}([["private_enc",t],["public_enc",n],["private_sign",r],["public_sign",i],["derived",o]],e.store)},this.getKey=function(t){return h(t,e.store)},this.getSignKey=function(t){return h(t,e.store)},this.clear=function(){return function(e=p()){return e("readwrite",(e=>(e.clear(),y(e.transaction))))}(e.store)}};function v(e){return(new TextEncoder).encode(e)}function b(e){return(new TextDecoder).decode(e)}function g(e){return Uint8Array.from(atob(e),(function(e){return e.charCodeAt(0)}))}function m(e){return btoa(Array.from(new Uint8Array(e)).map((function(e){return String.fromCharCode(e)})).join(""))}function A(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(e instanceof ArrayBuffer?new Uint8Array(e):e,0),n.set(t instanceof ArrayBuffer?new Uint8Array(t):t,e.byteLength),n.buffer}function E(e,t,n){var r=new Uint8Array(e.byteLength+t.byteLength+n.byteLength);return r.set(e instanceof ArrayBuffer?new Uint8Array(e):e,0),r.set(t instanceof ArrayBuffer?new Uint8Array(t):t,e.byteLength),r.set(n instanceof ArrayBuffer?new Uint8Array(n):n,e.byteLength+t.byteLength),r.buffer}function S(e){var t=Math.floor(e/Math.pow(2,32));return[t,t<<8,t<<16,t<<24,e,e<<8,e<<16,e<<24].map((function(e){return e>>>24}))}function K(e){return e instanceof Uint8Array?e.reduce((function(e,t,n){return e+t*Math.pow(2,56-8*n)}),0):e instanceof ArrayBuffer?new Uint8Array(e).reduce((function(e,t,n){return e+t*Math.pow(2,56-8*n)}),0):e.reduce((function(e,t,n){return e+t*Math.pow(2,56-8*n)}),0)}function P(e){var t="",n="0123456789ABCDEF";return(e instanceof ArrayBuffer?new Uint8Array(e):e).forEach((function(e){t+=n[e>>4]+n[15&e]})),t}function U(e){for(var t=[],n=0;n<e.length;n+=2)t.push(parseInt(e.substr(n,2),16));return new Uint8Array(t)}function k(e,t){return r(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,e()];case 1:return[2,n.sent()];case 2:throw n.sent(),t;case 3:return[2]}}))}))}"object"==typeof window&&"atob"in window&&"btoa"in window||(global.atob=function(e){return Buffer.from(e,"base64").toString("binary")},global.btoa=function(e){return Buffer.from(e,"binary").toString("base64")});var x=function(e,t,n){var o=this;this.endpoint=void 0,this.protocolVersion=void 0,this.jwt=void 0,this.registerUser=function(e,t,n,s,a,c,u){return r(o,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return[4,fetch(this.endpoint+"/api/v"+this.protocolVersion+"/users",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.jwt},body:JSON.stringify({publicEncryptionKey:m(e),publicSigningKey:m(t),encryptedPrivateEncryptionKey:m(n),encryptedPrivateSigningKey:m(s),keyDerivationSalt:m(a),signedJwt:m(c),signedPublicEncryptionKey:m(u)})})];case 1:return[4,B(r.sent(),(function(e){}))];case 2:return[2,r.sent()]}}))}))},this.getUserData=function(){return r(o,void 0,void 0,(function(){function e(e){return{type:"UserFound",userData:{enc_PK:e.publicEncryptionKey,e_enc_SK:e.encryptedPrivateEncryptionKey,sign_PK:e.publicSigningKey,e_sign_SK:e.encryptedPrivateSigningKey,salt:e.keyDerivationSalt}}}return i(this,(function(t){switch(t.label){case 0:return[4,fetch(this.endpoint+"/api/v"+this.protocolVersion+"/keys/me",{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.jwt}})];case 1:return[4,B(t.sent(),e,{type:"UserNotFound"})];case 2:return[2,t.sent()]}}))}))},this.getUsersPublicKey=function(e){return r(o,void 0,void 0,(function(){function t(e){return{type:"UserFound",publicEncryptionKey:e.publicEncryptionKey,publicSigningKey:e.publicSigningKey}}return i(this,(function(n){switch(n.label){case 0:return[4,fetch(this.endpoint+"/api/v"+this.protocolVersion+"/keys/"+e,{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.jwt}})];case 1:return[4,B(n.sent(),t,{type:"UserNotFound"})];case 2:return[2,n.sent()]}}))}))},this.getGroupPublicKeys=function(){return r(o,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,fetch(this.endpoint+"/api/v"+this.protocolVersion+"/keys",{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.jwt}})];case 1:return[4,B(e.sent(),(function(e){return e}))];case 2:return[2,e.sent()]}}))}))},this.postEncryptedKeys=function(e){return r(o,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,fetch(this.endpoint+"/api/v"+this.protocolVersion+"/documents",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.jwt},body:JSON.stringify(e)})];case 1:return[4,B(t.sent(),(function(e){return e}))];case 2:return[2,t.sent()]}}))}))},this.getDataKey=function(e){return r(o,void 0,void 0,(function(){function t(e){return{type:"KeyFound",key:e}}return i(this,(function(n){switch(n.label){case 0:return[4,fetch(this.endpoint+"/api/v"+this.protocolVersion+"/documents/keys/"+e,{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.jwt}})];case 1:return[4,B(n.sent(),t,{type:"KeyNotFound"})];case 2:return[2,n.sent()]}}))}))},this.getDataKeys=function(){return r(o,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return[4,fetch(this.endpoint+"/api/v"+this.protocolVersion+"/documents/keys",{method:"GET",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.jwt}})];case 1:return[4,B(e.sent(),(function(e){return e}))];case 2:return[2,e.sent()]}}))}))},this.updateUser=function(e,t,n){return r(o,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return[4,fetch(this.endpoint+"/api/v"+this.protocolVersion+"/keys/me",{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.jwt},body:JSON.stringify({encryptedPrivateEncryptionKey:m(e),encryptedPrivateSigningKey:m(t),keyDerivationSalt:m(n)})})];case 1:return[4,B(r.sent(),(function(e){}))];case 2:return[2,r.sent()]}}))}))},this.giveAccess=function(e,t){return r(o,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:return[4,fetch(this.endpoint+"/api/v"+this.protocolVersion+"/documents/keys/user/"+e,{method:"PUT",mode:"cors",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.jwt},body:JSON.stringify(t)})];case 1:return[4,B(n.sent(),(function(e){}))];case 2:return[2,n.sent()]}}))}))},this.jwt=e,this.endpoint=t,this.protocolVersion=n};function B(e,t,n){return r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:switch(e.status){case 200:return[3,1];case 401:return[3,3];case 400:case 404:return[3,4]}return[3,5];case 1:return[4,e.json()];case 2:return r=i.sent(),[2,{type:"Success",data:t(r)}];case 3:return[2,{type:"AuthenticationNeeded"}];case 4:return null!=n?[2,{type:"Success",data:n}]:[2,{type:"Failed"}];case 5:return[2,{type:"Failed"}]}}))}))}var O=function(e){function n(){var t=this.constructor,n=e.call(this,"Authentication to blindnet failed. Please generate a valid token.")||this;return n.code=1,n.name="AuthenticationError",Object.setPrototypeOf(n,t.prototype),n}return t(n,e),n}(Error),j=function(e){function n(t){var n=this.constructor,r=e.call(this,t)||this;return r.code=2,r.name="UserNotInitializedError",Object.setPrototypeOf(r,n.prototype),r}return t(n,e),n}(Error),R=function(e){function n(){var t=this.constructor,n=e.call(this,"Wrong password provided.")||this;return n.code=3,n.name="PasswordError",Object.setPrototypeOf(n,t.prototype),n}return t(n,e),n}(Error),_=function(e){function n(t){var n=this.constructor,r=e.call(this,t)||this;return r.code=4,r.name="EncryptionError",Object.setPrototypeOf(r,n.prototype),r}return t(n,e),n}(Error),T=function(e){function n(t){var n=this.constructor,r=e.call(this,t)||this;return r.code=5,r.name="BlindnetServiceError",Object.setPrototypeOf(r,n.prototype),r}return t(n,e),n}(Error),C=function(e){function n(){var t=this.constructor,n=e.call(this,"No users to encrypt the data to")||this;return n.code=6,n.name="NotEncryptabeError",Object.setPrototypeOf(n,t.prototype),n}return t(n,e),n}(Error),F=function(e){function n(t){var n=this.constructor,r=e.call(this,t)||this;return r.code=7,r.name="NoAccessError",Object.setPrototypeOf(r,n.prototype),r}return t(n,e),n}(Error),G=function(e){function n(t){var n=this.constructor,r=e.call(this,t)||this;return r.code=8,r.name="UserNotFoundError",Object.setPrototypeOf(r,n.prototype),r}return t(n,e),n}(Error),I=function(e){function n(t){var n=this.constructor,r=e.call(this,t)||this;return r.code=9,r.name="BadFormatError",Object.setPrototypeOf(r,n.prototype),r}return t(n,e),n}(Error),N=Object.freeze({__proto__:null,AuthenticationError:O,UserNotInitializedError:j,PasswordError:R,EncryptionError:_,BlindnetServiceError:T,NotEncryptabeError:C,NoAccessError:F,UserNotFoundError:G,BadFormatError:I});function D(e,t,n){return void 0===n&&(n=!1),r(this,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return[4,crypto.subtle.importKey("raw",v(e),"PBKDF2",!1,["deriveKey"])];case 1:return r=i.sent(),[4,crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},n,["decrypt","encrypt","wrapKey","unwrapKey"])];case 2:return[2,i.sent()]}}))}))}function V(e){return void 0===e&&(e=!1),r(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,crypto.subtle.generateKey({name:"AES-GCM",length:256},e,["encrypt","decrypt"])];case 1:return[2,t.sent()]}}))}))}function M(e){return void 0===e&&(e=!1),r(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},e,["encrypt","decrypt","wrapKey","unwrapKey"])];case 1:return[2,t.sent()]}}))}))}function H(e,t,n){return r(this,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return[4,crypto.subtle.wrapKey("jwk",e,t,{name:"AES-GCM",iv:n})];case 1:return[2,r.sent()]}}))}))}function z(e,t){if("AuthenticationNeeded"===e.type)throw new O;if("Failed"===e.type)throw new T(t);return e.data}return{Blindnet:function(){function e(e,t){this.prefix=[35,98,108,105,110,100,110,101,116,35],this.service=e,this.keyStore=t}return e.initTest=function(t,n){return new e(t,n)},e.init=function(t,n){return void 0===n&&(n="https://api.blindnet.io"),new e(new x(t,n,e.protocolVersion),new w)},e.disconnect=function(){(new w).clear()},e.prototype.refreshToken=function(t){this.service=new x(t,this.service.endpoint,e.protocolVersion)},e.deriveSecrets=function(e){return r(this,void 0,void 0,(function(){var t,n,r,o,s;return i(this,(function(i){switch(i.label){case 0:return[4,crypto.subtle.importKey("raw",v(e),"PBKDF2",!1,["deriveBits"])];case 1:return t=i.sent(),n=new Uint8Array([241,211,153,239,17,34,5,112,167,218,57,131,99,29,243,84]),[4,crypto.subtle.deriveBits({name:"PBKDF2",salt:n,iterations:64206,hash:"SHA-256"},t,512)];case 2:return r=i.sent(),o=new Uint8Array(r,0,32),s=new Uint8Array(r,32,32),[2,{blindnetSecret:m(o),appSecret:m(s)}]}}))}))},e.prototype.connect=function(e){return r(this,void 0,void 0,(function(){var t,n,r,o,s,a,y,l,d,p,h,w,b,m,E,S,K,P,U,x,B,O,j;return i(this,(function(i){switch(i.label){case 0:return[4,this.keyStore.clear()];case 1:return i.sent(),[4,this.service.getUserData()];case 2:switch(t=i.sent(),n=z(t,"Fetching user data failed"),n.type){case"UserNotFound":return[3,3];case"UserFound":return[3,14]}return[3,20];case 3:return[4,M(!0)];case 4:return r=i.sent(),o=c.randomPrivateKey(),[4,f(o)];case 5:return s=i.sent(),[4,crypto.subtle.exportKey("spki",r.publicKey)];case 6:return a=i.sent(),P=crypto.getRandomValues(new Uint8Array(16)),[4,D(e,P)];case 7:return y=i.sent(),[4,u(new Uint8Array(v(this.service.jwt)),o)];case 8:return l=i.sent(),[4,u(new Uint8Array(a),o)];case 9:return d=i.sent(),p=new Uint8Array(12),[4,H(r.privateKey,y,p)];case 10:return h=i.sent(),[4,crypto.subtle.encrypt({name:"AES-GCM",iv:p},y,A(o,s))];case 11:return w=i.sent(),[4,this.service.registerUser(a,s,h,w,P,l,d)];case 12:return z(i.sent(),"User could not be registered"),[4,this.keyStore.storeKeys(r.privateKey,r.publicKey,o,s,y)];case 13:return i.sent(),[2,void 0];case 14:return b=n.userData,m=b.enc_PK,E=b.e_enc_SK,S=b.sign_PK,K=b.e_sign_SK,P=b.salt,[4,crypto.subtle.importKey("spki",g(m),{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"])];case 15:return U=i.sent(),[4,D(e,g(P))];case 16:return x=i.sent(),B=new Uint8Array(12),[4,k((function(){return crypto.subtle.unwrapKey("jwk",g(E),x,{name:"AES-GCM",iv:B},{name:"RSA-OAEP",hash:"SHA-256"},!0,["decrypt","unwrapKey"])}),new R)];case 17:return O=i.sent(),[4,crypto.subtle.decrypt({name:"AES-GCM",iv:B},x,g(K))];case 18:return j=i.sent(),[4,this.keyStore.storeKeys(O,U,new Uint8Array(j).slice(0,32),g(S),x)];case 19:return i.sent(),[2,void 0];case 20:return[2]}}))}))},e.prototype.encrypt=function(e,t){return r(this,void 0,void 0,(function(){var o,s,a,c,u,f,y,l,d,p,h,w,b,A,K=this;return i(this,(function(P){switch(P.label){case 0:if("object"!=typeof(o=t||{}))throw new I("Metadata has to be an object");return"string"!=typeof e?[3,1]:(s=v(e),o=n(n({},o),{dataType:{type:"STRING"}}),[3,4]);case 1:return e instanceof File?[4,e.arrayBuffer()]:[3,3];case 2:return s=P.sent(),o=n(n({},o),{dataType:{type:"FILE",name:e.name}}),[3,4];case 3:if(!(e instanceof ArrayBuffer||e instanceof Uint8Array))throw new I("Encryption of provided data format is not supported");s=e,o=n(n({},o),{dataType:{type:"BYTES"}}),P.label=4;case 4:return a=v(JSON.stringify(o)),[4,this.service.getGroupPublicKeys()];case 5:if(c=P.sent(),0==(u=z(c,"Fetching public keys failed")).length)throw new C;return[4,V(!0)];case 6:return f=P.sent(),y=crypto.getRandomValues(new Uint8Array(12)),l=S(a.byteLength),d=E(new Uint8Array(l),a,s),[4,crypto.subtle.encrypt({name:"AES-GCM",iv:y},f,d)];case 7:return p=P.sent(),[4,Promise.all(u.map((function(e){return r(K,void 0,void 0,(function(){var t,n;return i(this,(function(r){switch(r.label){case 0:return[4,crypto.subtle.importKey("spki",g(e.publicEncryptionKey),{name:"RSA-OAEP",hash:"SHA-256"},!0,["wrapKey"])];case 1:return t=r.sent(),[4,crypto.subtle.wrapKey("jwk",f,t,{name:"RSA-OAEP"})];case 2:return n=r.sent(),[2,{userID:e.userID,encryptedSymmetricKey:m(n)}]}}))}))})))];case 8:return h=P.sent(),[4,this.service.postEncryptedKeys(h)];case 9:return w=P.sent(),b=z(w,"Could not upload the encrypted public keys"),A=E(v(b),y.buffer,p),[2,{dataId:b,encryptedData:A}]}}))}))},e.prototype.encryptValues=function(e,t){return r(this,void 0,void 0,(function(){var o,s,a,c,u,f,y,l,d,p=this;return i(this,(function(h){switch(h.label){case 0:if("object"!=typeof e)throw new I("Data has to be an object");return[4,this.service.getGroupPublicKeys()];case 1:if(o=h.sent(),0==(s=z(o,"Fetching public keys failed")).length)throw new C;return[4,V(!0)];case 2:return a=h.sent(),c=crypto.getRandomValues(new Uint8Array(12)),[4,Promise.all(Object.entries(e).map((function(e){return r(p,void 0,void 0,(function(){var n,r,o,s,u,f;return i(this,(function(i){switch(i.label){case 0:return n=e[0],r=e[1],s=Uint8Array.bind,[4,crypto.subtle.digest("SHA-256",A(v(n),c))];case 1:return o=(new(s.apply(Uint8Array,[void 0,i.sent()]))).slice(0,12),[4,crypto.subtle.encrypt({name:"AES-GCM",iv:o},a,v(r))];case 2:return u=i.sent(),f=t?A(o,u):E(new Uint8Array(this.prefix),new Uint8Array(S(12+u.byteLength)),A(o,u)),[2,{key:n,encryptedValue:P(f)}]}}))}))})))];case 3:return u=h.sent(),[4,Promise.all(s.map((function(e){return r(p,void 0,void 0,(function(){var t,n;return i(this,(function(r){switch(r.label){case 0:return[4,crypto.subtle.importKey("spki",g(e.publicEncryptionKey),{name:"RSA-OAEP",hash:"SHA-256"},!0,["wrapKey"])];case 1:return t=r.sent(),[4,crypto.subtle.wrapKey("jwk",a,t,{name:"RSA-OAEP"})];case 2:return n=r.sent(),[2,{userID:e.userID,encryptedSymmetricKey:m(n)}]}}))}))})))];case 4:return f=h.sent(),[4,this.service.postEncryptedKeys(f)];case 5:return y=h.sent(),l=z(y,"Could not upload the encrypted public keys"),d=u.reduce((function(e,t){var r;return n(n({},e),((r={})[t.key]=t.encryptedValue,r))}),{dataId:l}),[2,{dataId:l,encryptedData:d}]}}))}))},e.prototype.decrypt=function(e){return r(this,void 0,void 0,(function(){var t,n,r,o,s,a,c,u,f,y,l,d,p=this;return i(this,(function(i){switch(i.label){case 0:return[4,k((function(){return p.keyStore.getKey("private_enc")}),new j("Private key not found"))];case 1:return t=i.sent(),n=b(e.slice(0,36)),[4,this.service.getDataKey(n)];case 2:if(r=i.sent(),"KeyNotFound"===(o=z(r,"Fetching data key failed for data with id "+n)).type)throw new F("A user has no access to data with id "+n);return s=o.key,[4,k((function(){return crypto.subtle.unwrapKey("jwk",g(s),t,{name:"RSA-OAEP"},{name:"AES-GCM",length:256},!1,["decrypt"])}),new _("Encrypted data key for data with id "+n+" could not be decrypted"))];case 3:return a=i.sent(),[4,k((function(){return crypto.subtle.decrypt({name:"AES-GCM",iv:e.slice(36,48)},a,e.slice(48))}),new _("Encrypted data with id "+n+" could not be decrypted"))];case 4:return c=i.sent(),u=K(Array.from(new Uint8Array(c.slice(0,8)))),f=c.slice(8,8+u),y=c.slice(8+u),"STRING"===(l=JSON.parse(b(f))).dataType.type?d=b(y):"FILE"===l.dataType.type?d=new File([y],l.dataType.name):"BYTES"===l.dataType.type&&(d=y),[2,{data:d,metadata:l}]}}))}))},e.prototype.decryptValues=function(e,t){return r(this,void 0,void 0,(function(){var o,s,a,c,u,f,y,l=this;return i(this,(function(d){switch(d.label){case 0:return[4,k((function(){return l.keyStore.getKey("private_enc")}),new j("Private key not found"))];case 1:if(o=d.sent(),null==(s=e.dataId))throw new _("dataId field missing from the input data");return[4,this.service.getDataKey(s)];case 2:if(a=d.sent(),"KeyNotFound"===(c=z(a,"Fetching data key failed for data with id "+s)).type)throw new F("A user has no access to data with id "+s);return u=c.key,[4,k((function(){return crypto.subtle.unwrapKey("jwk",g(u),o,{name:"RSA-OAEP"},{name:"AES-GCM",length:256},!1,["decrypt"])}),new _("Encrypted data key for data with id "+s+" could not be decrypted"))];case 3:return f=d.sent(),[4,Promise.all(Object.entries(e).filter((function(e){return"dataId"!==e[0]})).map((function(e){return r(l,void 0,void 0,(function(){var n,r,o,a,c;return i(this,(function(i){switch(i.label){case 0:return n=e[0],r=U(e[1]),o=t?r.slice(0,12):r.slice(this.prefix.length+8,this.prefix.length+8+12),a=t?r.slice(12):r.slice(this.prefix.length+8+12),[4,k((function(){return crypto.subtle.decrypt({name:"AES-GCM",iv:o},f,a)}),new _("Encrypted values with id "+s+" could not be decrypted"))];case 1:return c=i.sent(),[2,{key:n,decryptedValue:b(c)}]}}))}))})))];case 4:return y=d.sent(),[2,{data:y.reduce((function(e,t){var r;return n(n({},e),((r={})[t.key]=t.decryptedValue,r))}),{})}]}}))}))},e.prototype.decryptStream=function(e,t){return r(this,void 0,void 0,(function(){var n,o,s,a,c,u,f,y,l=this;return i(this,(function(d){switch(d.label){case 0:return[4,k((function(){return l.keyStore.getKey("private_enc")}),new j("Private key not found"))];case 1:return n=d.sent(),[4,this.service.getDataKey(e)];case 2:if(o=d.sent(),"KeyNotFound"===(s=z(o,"Fetching data key failed for data with id "+e)).type)throw new F("A user has no access to data with id "+e);return a=s.key,[4,k((function(){return crypto.subtle.unwrapKey("jwk",g(a),n,{name:"RSA-OAEP"},{name:"AES-GCM",length:256},!1,["decrypt"])}),new _("Encrypted data key for data with id "+e+" could not be decrypted"))];case 3:return c=d.sent(),u=[50,51,54,50,54,67,54,57,54,69,54,52,54,69,54,53,55,52,50,51],f={parts:[]},y=t.getReader(),[2,new ReadableStream({start:function(t){return function n(){return r(this,void 0,void 0,(function(){var r,o,s,a,l;return i(this,(function(d){switch(d.label){case 0:return[4,y.read()];case 1:if(r=d.sent(),o=r.done,s=r.value,o)return t.close(),[2];f=function(e,t){for(var n=t.sf,r=t.fi,i=t.rl,o=t.il,s=t.bl,a=t.l,c=t.rd,f=t.dpi,y=t.di,l=t.d,d=null==n||n,p=null==r?0:r,h=null!=i&&i,w=null==o?0:o,v=null==s?[]:s,g=a,m=null!=c&&c,A=null==f?0:f,E=null==y?0:y,S=null==l?[]:l,P=0,k=[],x=0;x<e.length;x++){if(m&&(S.push(e[x]),++A==2*g)){m=!1,A=0,g=0,d=!0;var B=U(b(new Uint8Array(S)));k.push({encrypted:!0,value:B}),S=[],P=++x}h&&(v.push(e[x]),16==++w&&(g=K(U(b(new Uint8Array(v).buffer))),w=0,v=[],h=!1,m=!0)),d&&(e[x]==u[p]?++p==u.length&&(d=!1,p=0,h=!0,x>u.length&&(O=e.slice(P,x-u.length+1)).length>0&&k.push({encrypted:!1,value:O})):p=0)}var O,j=h||m;return j||(O=e.slice(P,e.length-p)).length>0&&k.push({encrypted:!1,value:O}),{reading:j,parts:k,sf:d,fi:p,rl:h,il:w,bl:v,l:g,rd:m,dpi:A,di:E,d:S}}(s,f),a=function(n){var r,o,s,a,u,y,l;return i(this,(function(i){switch(i.label){case 0:return r=f.parts[n],o=r.encrypted,s=r.value,o?(a=[s.slice(0,12),s.slice(12)],u=a[0],y=a[1],[4,k((function(){return crypto.subtle.decrypt({name:"AES-GCM",iv:u},c,y)}),new _("Encrypted values with id "+e+" could not be decrypted"))]):[3,2];case 1:return l=i.sent(),t.enqueue(new Uint8Array(l)),[3,3];case 2:t.enqueue(s),i.label=3;case 3:return[2]}}))},l=0,d.label=2;case 2:return l<f.parts.length?[5,a(l)]:[3,5];case 3:d.sent(),d.label=4;case 4:return l++,[3,2];case 5:return[2,n()]}}))}))}()}})]}}))}))},e.prototype.changeSecret=function(e,t){return r(this,void 0,void 0,(function(){var n,r,o,s,a,c,u,f,y,l,d,p,h,w,v,b,m,A=this;return i(this,(function(i){switch(i.label){case 0:return null!=t?[3,9]:[4,k((function(){return A.keyStore.getKey("private_enc")}),new j("Private key not found"))];case 1:return d=i.sent(),[4,k((function(){return A.keyStore.getSignKey("private_sign")}),new j("Private key not found"))];case 2:return p=i.sent(),[4,k((function(){return A.keyStore.getKey("derived")}),new j("Password derived key not found"))];case 3:return i.sent(),f=crypto.getRandomValues(new Uint8Array(16)),[4,D(e,f)];case 4:return w=i.sent(),n=new Uint8Array(12),[4,H(d,w,n)];case 5:return b=i.sent(),[4,crypto.subtle.encrypt({name:"AES-GCM",iv:n},w,p)];case 6:return m=i.sent(),[4,this.service.updateUser(b,m,f)];case 7:return z(r=i.sent(),"Could not upload the new keys"),[4,this.keyStore.storeKey("derived",w)];case 8:return i.sent(),[2,void 0];case 9:return[4,this.service.getUserData()];case 10:if(r=i.sent(),"UserNotFound"==(o=z(r,"Fetching user data failed")).type)throw new G("");return s=o.userData,a=s.enc_PK,c=s.e_enc_SK,u=s.e_sign_SK,f=s.salt,[4,crypto.subtle.importKey("spki",g(a),{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"])];case 11:return i.sent(),[4,D(t,g(f))];case 12:return y=i.sent(),l=new Uint8Array(12),[4,k((function(){return crypto.subtle.unwrapKey("jwk",g(c),y,{name:"AES-GCM",iv:l},{name:"RSA-OAEP",hash:"SHA-256"},!0,["decrypt","unwrapKey"])}),new R)];case 13:return d=i.sent(),[4,crypto.subtle.decrypt({name:"AES-GCM",iv:l},y,g(u))];case 14:return p=i.sent(),h=crypto.getRandomValues(new Uint8Array(16)),[4,D(e,h)];case 15:return w=i.sent(),v=new Uint8Array(12),[4,H(d,w,v)];case 16:return b=i.sent(),[4,crypto.subtle.encrypt({name:"AES-GCM",iv:v},w,p)];case 17:return m=i.sent(),[4,this.service.updateUser(b,m,h)];case 18:return z(i.sent(),"Could not upload the new keys"),[4,this.keyStore.storeKey("derived",w)];case 19:return i.sent(),[2,void 0]}}))}))},e.prototype.giveAccess=function(e){return r(this,void 0,void 0,(function(){var t,n,o,s,a,c,u,f,y=this;return i(this,(function(l){switch(l.label){case 0:return[4,k((function(){return y.keyStore.getKey("private_enc")}),new j("Private key not found"))];case 1:return t=l.sent(),[4,this.service.getUsersPublicKey(e)];case 2:if(n=l.sent(),"UserNotFound"==(o=z(n,"Fetching the public key of a user "+e+" failed")).type)throw new G("User "+e+" not registered.");return[4,this.service.getDataKeys()];case 3:return s=l.sent(),a=z(s,"Fetching the encrypted data keys failed"),c=o.publicEncryptionKey,[4,crypto.subtle.importKey("spki",g(c),{name:"RSA-OAEP",hash:"SHA-256"},!1,["wrapKey"])];case 4:return u=l.sent(),[4,Promise.all(a.map((function(e){return r(y,void 0,void 0,(function(){var n,r;return i(this,(function(i){switch(i.label){case 0:return[4,k((function(){return crypto.subtle.unwrapKey("jwk",g(e.encryptedSymmetricKey),t,{name:"RSA-OAEP"},{name:"AES-GCM",length:256},!0,["decrypt"])}),new _("Could not decrypt a data key for data id "+e.documentID))];case 1:return n=i.sent(),[4,crypto.subtle.wrapKey("jwk",n,u,{name:"RSA-OAEP"})];case 2:return r=i.sent(),[2,{documentID:e.documentID,encryptedSymmetricKey:m(r)}]}}))}))})))];case 5:return f=l.sent(),[4,this.service.giveAccess(e,f)];case 6:return z(l.sent(),"Uploading the encrypted data keys for a user "+e+" failed"),[2,void 0]}}))}))},e.protocolVersion="1",e}(),util:{toBase64:m,fromBase64:g,toHex:P,fromHex:U},error:N}}));
